---  
- name: Upload parameters.yml
  copy:
    src: parameters.yml
    dest: "{{ ansistrano_release_path.stdout }}/app/config/parameters.yml"

- name: Create logs folder for symlinks
  file:
    path: "{{ release_logs_path }}"
    state: directory

- name: Remove sensitive scripts from web/ dir
  file:
    path: '{{ release_web_path }}/{{ item }}'
    state: absent
  with_items:
    - app_dev.php
    - config.php
    
- name: Refresh permissions for all files
  file:
    path: /opt
    owner: web
    group: ansible
    mode: 0775
    recurse: true

- name: Install Composer dependencies
  composer:
    command: install
    arguments: --classmap-authoritative
    no_dev: yes
    optimize_autoloader: yes
    working_dir: "{{ ansistrano_release_path.stdout }}"
  become_user: web

- name: Install Npm dependencies
  npm:
    production: true
    path: "{{ ansistrano_release_path.stdout }}"
  become_user: web

- name: Compile assets for production (shell module version)
  shell: npm run build -- --mode=production
  args:
    chdir: "{{ ansistrano_release_path.stdout }}"
  become_user: web

- name: Copy Nginx vhost configuration file
  template: 
    src: web.conf.j2
    dest: /etc/nginx/sites-available/web.conf
    owner: root
    group: root
    mode: 0644

- name: Activate vhost with symlink
  file: 
    src: /etc/nginx/sites-available/web.conf
    dest: /etc/nginx/sites-enabled/web.conf
    state: link
  notify: 
    - restart nginx
    - restart php-fpm

- name: supervisor | Upload spoolsend configuration file
  template:
    src: spoolsend.conf.j2
    dest: /etc/supervisor/conf.d/spoolsend.conf
    owner: root
    group: root
    mode: 0644